
<def-group>
  <definition class="compliance" id="scc_limit_root_containers" version="1">
    <metadata>
        <title>Limit Container Running As Root User</title>
        
    <affected family="unix">
    <platform>Red Hat OpenShift Container Platform 4</platform>
    </affected>
        <description>In the YAML/JSON file '/apis/security.openshift.io/v1/securitycontextconstraints' at path '.items[:]['runAsUser']' at least one: key 'type' value equals 'MustRunAsNonRoot'</description>
    </metadata><criteria>
        <criterion  comment="In the YAML/JSON file &#39;/apis/security.openshift.io/v1/securitycontextconstraints&#39; at path &#39;.items[:][&#39;runAsUser&#39;]&#39; at least one" test_ref="test_scc_limit_root_containers"/>
        
        <criterion comment="Make sure that the file '/apis/security.openshift.io/v1/securitycontextconstraints' exists." test_ref="test_file_for_scc_limit_root_containers"/>
        
    </criteria>
  </definition>

  <local_variable id="scc_limit_root_containers_file_location" datatype="string" comment="The actual path of the file to scan." version="1">
      
      <concat>
        <variable_component var_ref="ocp_data_root"/>
        <literal_component>/apis/security.openshift.io/v1/securitycontextconstraints</literal_component>
      </concat>
      
  </local_variable>

  <ind:yamlfilecontent_test id="test_scc_limit_root_containers" check="all" check_existence="at_least_one_exists"
     comment="In the file &#39;/apis/security.openshift.io/v1/securitycontextconstraints&#39; find only one object at path &#39;.items[:][&#39;runAsUser&#39;]&#39;." version="1">
    <ind:object object_ref="object_scc_limit_root_containers"/>
    <ind:state state_ref="state_scc_limit_root_containers"/>
  </ind:yamlfilecontent_test>

  
  <unix:file_test id="test_file_for_scc_limit_root_containers" check="all" check_existence="only_one_exists"
    comment="Find the file to be checked ('/apis/security.openshift.io/v1/securitycontextconstraints')." version="1">
    <unix:object object_ref="object_file_for_scc_limit_root_containers"/>
  </unix:file_test>
  

  <unix:file_object id="object_file_for_scc_limit_root_containers" version="1">
    <unix:filepath var_ref="scc_limit_root_containers_file_location"/>
  </unix:file_object>

  <ind:yamlfilecontent_object id="object_scc_limit_root_containers" version="1">
    <ind:filepath var_ref="scc_limit_root_containers_file_location"/>
    <ind:yamlpath>.items[:]['runAsUser']</ind:yamlpath>
  </ind:yamlfilecontent_object>

  <ind:yamlfilecontent_state id="state_scc_limit_root_containers" version="1">
    <ind:value datatype="record" entity_check="at least one">
      
      <field  name="type" datatype="string">MustRunAsNonRoot</field>
      
    </ind:value>
  </ind:yamlfilecontent_state>

  
  <external_variable comment="Root of OCP data dump" datatype="string" id="ocp_data_root" version="1" />
  

</def-group>
