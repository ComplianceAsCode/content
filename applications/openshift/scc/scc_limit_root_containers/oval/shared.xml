
<def-group>
  <definition class="compliance" id="scc_limit_root_containers" version="1">
    <metadata>
        <title>Limit Container Running As Root User</title>
    <affected family="unix">
    <platform>Red Hat OpenShift Container Platform 4</platform>
    </affected>
        <description>Check SCCs runAsUser and Namespaces UID ranges</description>
        </metadata>
        <criteria>
            <criteria operator="OR">
                <criterion  comment="In the YAML/JSON file &#39;/apis/security.openshift.io/v1/securitycontextconstraints&#39; at path &#39;.items[:][&#39;runAsUser&#39;]&#39; at least one MustRunAsNonRoot" test_ref="test_scc_limit_root_containers_non_root"/>
                <criteria>
                    <criterion  comment="In the YAML/JSON file &#39;/apis/security.openshift.io/v1/securitycontextconstraints&#39; at path &#39;.items[:][&#39;runAsUser&#39;]&#39; at least one MustRunAs" test_ref="test_scc_limit_root_containers_run_as"/>
                    <criterion  comment="In the YAML/JSON file &#39;/api/v1/namespaces&#39; at path &#39;openshift.io/sa.scc.uid-range&#39; at least one namespace doesn&#39;t allow UID 0" test_ref="test_scc_limit_root_containers_non_root_uid_range"/>
                </criteria>
            </criteria>

        <criterion comment="Make sure that the file '/apis/security.openshift.io/v1/securitycontextconstraints' exists." test_ref="test_file_for_scc_limit_root_containers"/>
    </criteria>
  </definition>

  <local_variable id="scc_limit_root_containers_file_location_namespace" datatype="string" comment="Path to namespaces resources" version="1">
      <concat>
        <variable_component var_ref="ocp_data_root"/>
        <literal_component>/api/v1/namespaces</literal_component>
      </concat>
  </local_variable>

  <local_variable id="scc_limit_root_containers_file_location" datatype="string" comment="Path to SSCs resources" version="1">
      <concat>
        <variable_component var_ref="ocp_data_root"/>
        <literal_component>/apis/security.openshift.io/v1/securitycontextconstraints</literal_component>
      </concat>
  </local_variable>

  <ind:yamlfilecontent_test id="test_scc_limit_root_containers_non_root" check="all" check_existence="at_least_one_exists"
     comment="In the file &#39;/apis/security.openshift.io/v1/securitycontextconstraints&#39; find only one object at path &#39;.items[:][&#39;runAsUser&#39;]&#39;." version="1">
    <ind:object object_ref="object_scc_limit_root_containers_non_root"/>
    <ind:state state_ref="state_scc_limit_root_containers_non_root"/>
  </ind:yamlfilecontent_test>
  <ind:yamlfilecontent_object id="object_scc_limit_root_containers_non_root" version="1">
    <ind:filepath var_ref="scc_limit_root_containers_file_location"/>
    <ind:yamlpath>.items[:]['runAsUser']</ind:yamlpath>
  </ind:yamlfilecontent_object>
  <ind:yamlfilecontent_state id="state_scc_limit_root_containers_non_root" version="1">
    <ind:value datatype="record" entity_check="at least one">
      <field  name="type" datatype="string">MustRunAsNonRoot</field>
    </ind:value>
  </ind:yamlfilecontent_state>

  <ind:yamlfilecontent_test id="test_scc_limit_root_containers_run_as" check="all" check_existence="at_least_one_exists"
     comment="In the file &#39;/apis/security.openshift.io/v1/securitycontextconstraints&#39; find only one object at path &#39;.items[:][&#39;runAsUser&#39;]&#39;." version="1">
    <ind:object object_ref="object_scc_limit_root_containers_run_as"/>
    <ind:state state_ref="state_scc_limit_root_containers_run_as"/>
  </ind:yamlfilecontent_test>
  <ind:yamlfilecontent_object id="object_scc_limit_root_containers_run_as" version="1">
    <ind:filepath var_ref="scc_limit_root_containers_file_location"/>
    <ind:yamlpath>.items[:]['runAsUser']</ind:yamlpath>
  </ind:yamlfilecontent_object>
  <ind:yamlfilecontent_state id="state_scc_limit_root_containers_run_as" version="1">
    <ind:value datatype="record" entity_check="at least one">
      <field  name="type" datatype="string">MustRunAs</field>
    </ind:value>
  </ind:yamlfilecontent_state>

  <ind:yamlfilecontent_test id="test_scc_limit_root_containers_non_root_uid_range" check="all" check_existence="at_least_one_exists"
     comment="In the YAML/JSON file &#39;/api/v1/namespaces&#39; at path &#39;openshift.io/sa.scc.uid-range&#39; at least one namespace doesn&#39;t allow UID 0" version="1">
    <ind:object object_ref="object_scc_limit_root_containers_non_root_uid_range"/>
    <ind:state state_ref="state_scc_limit_root_containers_non_root_uid_range"/>
  </ind:yamlfilecontent_test>
  <ind:yamlfilecontent_object id="object_scc_limit_root_containers_non_root_uid_range" version="1">
      <ind:filepath var_ref="scc_limit_root_containers_file_location_namespace"/>
    <ind:yamlpath>.items[:]['metadata']['annotations']['openshift.io/sa.scc.uid-range']</ind:yamlpath>
  </ind:yamlfilecontent_object>
  <ind:yamlfilecontent_state id="state_scc_limit_root_containers_non_root_uid_range" version="1">
    <ind:value datatype="record" >
        <field  name="#" datatype="string" operation="pattern match"
            entity_check="at least one">^(?!0*\/).*$</field>
    </ind:value>
  </ind:yamlfilecontent_state>

  <unix:file_test id="test_file_for_scc_limit_root_containers" check="all" check_existence="only_one_exists"
    comment="Find the file to be checked ('/apis/security.openshift.io/v1/securitycontextconstraints')." version="1">
    <unix:object object_ref="object_file_for_scc_limit_root_containers"/>
  </unix:file_test>
  <unix:file_object id="object_file_for_scc_limit_root_containers" version="1">
    <unix:filepath var_ref="scc_limit_root_containers_file_location"/>
  </unix:file_object>

  <external_variable comment="Root of OCP data dump" datatype="string" id="ocp_data_root" version="1" />
</def-group>
