documentation_complete: true

prodtype: ocp4

title: Ensure that the service-account-lookup argument is set to true

description: Validate service account before validating token.

rationale: |-
  If <tt>service-account-lookup</tt> is not enabled, the apiserver
  only verifies that the authentication token is valid, and
  does not validate that the service account token mentioned
  in the request is actually present in etcd. This allows
  using a service account token even after the corresponding
  service account is deleted. This is an example of time of
  check to time of use security issue.

identifiers:
  cce@ocp4: CCE-83370-7

severity: medium

references:
  cis: 1.2.27

ocil_clause: 'API server argument <tt>--service-account-lookup</tt> contains <tt>true</tt>'

ocil: |-
  Run the following command:
  <pre>$ oc get configmap config -n openshift-kube-apiserver -o json | \
      jq -r '.data["config.yaml"]' | \
      jq -r '.apiServerArguments["service-account-lookup"]'</pre>
  The output should return <pre>true</pre>.

warnings:
- general: |-
    {{{ openshift_cluster_setting("/api/v1/namespaces/openshift-kube-apiserver/configmaps/config") | indent(4) }}}
      
template:
  name: yamlfile_value
  vars:
    ocp_data: "true"
    entity_check: "at least one"
    filepath: /api/v1/namespaces/openshift-kube-apiserver/configmaps/config
    yamlpath: '.data["config.yaml"]'
    values:
    - value: 'service-account-lookup.*\["true"\]'
      operation: "pattern match"
      type: "string"
