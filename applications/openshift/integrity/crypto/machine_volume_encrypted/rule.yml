prodtype: ocp4

title: Ensure that full disk encryption is configured on cluster nodes

description: |-
  When full disk encryption is chosen as a way to protect card data at rest, OpenShift can provide
  several solutions depending on the hosting environment. 
  While LUKS (with TPM2 or Tang) can be used for bare metal use cases, EBS encryption can be used 
  when the cluster is hosted on AWS.
  
rationale: |-
  Use of weak or untested encryption algorithms undermines the purposes of utilizing encryption to
  protect data. The system must implement cryptographic modules adhering to the higher
  standards approved by the federal government since this provides assurance they have been tested
  and validated.


identifiers:
  cce@ocp4: CCE-85858-9

references:
  pcidss: Req-3.4.1

ocil_clause: 'FIPS mode is not enabled on worker nodes'

ocil: |-
    Run the following command to see if EBS encryption is enabled:
    <pre>$ oc get machineset --all-namespaces -o json | jq '[.items[] | .spec.template.spec.providerSpec.value.blockDevices[0].ebs.encrypted] | map(. == true)'</pre>
    Make sure that the result is an array of 'true' values.
    If not, run the following command to retrieve if the FIPS flag is enabled:
    <pre>$ oc get machineconfig -o json | jq '. | [select(.items[].metadata.name | test("^[0-9]{2}-worker$|^[0-9]{2}-master$"))]|[.[].items[].spec.fips]'</pre>
    Make sure that the result is an array of 'true' values.
    Then, run this next command to retrieve if LUKS encryption is enabled:
    <pre>$ oc get machineconfig -o json | jq '. | [select(.items[].metadata.name | test("^[0-9]{2}-worker$|^[0-9]{2}-master$"))]|map(.spec.config.storage.luks[0].clevis != null)'</pre>
    The result must also be an array of 'true' values.
severity: high
warnings:
- general: |-
    {{{ openshift_filtered_cluster_setting(
      {'/apis/machineconfiguration.openshift.io/v1/machineconfigs': '[.items[] | select(.metadata.name | test("^[0-9]{2}-worker$|^[0-9]{2}-master$"))]|map(.spec.fips == true)',
      '/apis/machineconfiguration.openshift.io/v1/machineconfigs': '[.items[] | select(.metadata.name | test("^[0-9]{2}-worker$|^[0-9]{2}-master$"))]|map(.spec.config.storage.luks[0].clevis != null)',
      '/apis/machine.openshift.io/v1beta1/machinesets?limit=500': '[.items[] | .spec.template.spec.providerSpec.value.blockDevices[0].ebs.encrypted] | map(. == true)'}
    ) | indent(4) }}}
