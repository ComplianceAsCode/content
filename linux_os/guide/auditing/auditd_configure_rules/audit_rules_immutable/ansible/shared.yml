# platform = multi_platform_all
# reboot = true
# strategy = restrict
# complexity = low
# disruption = low

- name: Collect all files from /etc/audit/rules.d with .rules extension
  find:
    paths: "/etc/audit/rules.d/"
    patterns: "*.rules"
  register: find_rules_d

- name: Remove the -e option from all Audit config files
  lineinfile:
    path: "{{ item }}"
    regexp: '^\s*(?:-e)\s+.*$'
    state: absent
  loop: "{{ find_rules_d.files | map(attribute='path') | list + ['/etc/audit/audit.rules'] }}"
  register: auditd_immutable_option
  
- name: Add Audit -e option into /etc/audit/rules.d/90-immutable.rules
  lineinfile:
    path: "{{ item }}"
    create: True
    line: "-e 2"
    mode: g-rwx,o-rwx
  loop:
    - "/etc/audit/rules.d/90-immutable.rules"
