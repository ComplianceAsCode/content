{{% macro test_sshd_lineinfile(filepath, param, id) %}}
{{%- set object_id = filepath | replace("/", "_") | replace("-", "_") | replace(".", "_") -%}}
  <ind:textfilecontent54_test id="{{{ id }}}" version="1" check="all"
    check_existence="only_one_exists" comment="Check if there is an {{{ param }}} entry in {{{ filepath }}}">
    <ind:object object_ref="object_{{{ param }}}{{{ object_id }}}" />
  </ind:textfilecontent54_test>
  <ind:textfilecontent54_object id="object_{{{ param }}}{{{ object_id }}}" version="1">
    <ind:filepath operation="pattern match">^{{{ filepath }}}</ind:filepath>
    <ind:pattern operation="pattern match" datatype="string">(?i)^[ ]*{{{ param }}}[ ]+((?:[^ \n]+[ ]*)+)$</ind:pattern>
    <ind:instance operation="greater than or equal" datatype="int">1</ind:instance>
  </ind:textfilecontent54_object>
{{% endmacro %}}

{{% macro test_sshd_lineindir(filepath, param, id) %}}
{{%- set object_id = filepath | replace("/", "_") | replace("-", "_") | replace(".", "_") -%}}
  <ind:textfilecontent54_test id="{{{ id }}}" version="1" check="all"
    check_existence="only_one_exists" comment="Check if there is an {{{ param }}} entry in {{{ filepath }}}">
    <ind:object object_ref="object_{{{ param }}}{{{ object_id }}}" />
  </ind:textfilecontent54_test>
  <ind:textfilecontent54_object id="object_{{{ param }}}{{{ object_id }}}" version="1">
    <ind:path>{{{ filepath }}}</ind:path>
    <ind:filename operation="pattern match">.*\.conf$</ind:filename>
    <ind:pattern operation="pattern match" datatype="string">(?i)^[ ]*{{{ param }}}[ ]+((?:[^ \n]+[ ]*)+)$</ind:pattern>
    <ind:instance operation="greater than or equal" datatype="int">1</ind:instance>
  </ind:textfilecontent54_object>
{{% endmacro %}}

<def-group>
  <definition class="compliance" id="{{{ rule_id }}}" version="1">
    {{{ oval_metadata("One of the following parameters of the sshd configuration file is set: AllowUsers, DenyUsers, AllowGroups, DenyGroups.", rule_title=rule_title) }}}
    <criteria operator="OR" comment="sshd limits the users who can log in">
      <criteria comment="AllowUsers, DenyUsers, AllowGroups, DenyGroups when using /etc/ssh/sshd_config" operator="AND">
        <criterion comment="SSH configuration /etc/ssh/sshd_config exists" test_ref="test_etc_ssh_sshd_config_exist"/>
        <criteria operator="OR">
            <criterion test_ref="test_allow_user_is_configured_etc_ssh_sshdconfig" />
            <criterion test_ref="test_allow_groups_is_configured_etc_ssh_sshdconfig" />
            <criterion test_ref="test_deny_users_is_configured_etc_ssh_sshdconfig" />
            <criterion test_ref="test_deny_groups_is_configured_etc_ssh_sshdconfig" />
            <criterion test_ref="test_allow_user_is_configured_etc_ssh_sshdconfig_dir" />
            <criterion test_ref="test_allow_groups_is_configured_etc_ssh_sshdconfig_dir" />
            <criterion test_ref="test_deny_users_is_configured_etc_ssh_sshdconfig_dir" />
            <criterion test_ref="test_deny_groups_is_configured_etc_ssh_sshdconfig_dir" />
            <criterion test_ref="test_allow_user_is_configured_usr_etc_ssh_sshdconfig_dir" />
            <criterion test_ref="test_allow_groups_is_configured_usr_etc_ssh_sshdconfig_dir" />
            <criterion test_ref="test_deny_users_is_configured_usr_etc_ssh_sshdconfig_dir" />
            <criterion test_ref="test_deny_groups_is_configured_usr_etc_ssh_sshdconfig_dir" />
        </criteria>
      </criteria>
      <criteria comment="AllowUsers, DenyUsers, AllowGroups, DenyGroups when using /usr/etc/ssh/sshd_config" operator="AND">
        <criterion comment="SSH configuration /etc/ssh/sshd_config does not exists" test_ref="test_etc_ssh_sshd_config_exist" negate="true"/>
        <criteria operator="OR">
            <criterion test_ref="test_allow_user_is_configured_usr_etc_ssh_sshdconfig" />
            <criterion test_ref="test_allow_groups_is_configured_usr_etc_ssh_sshdconfig" />
            <criterion test_ref="test_deny_users_is_configured_usr_etc_ssh_sshdconfig" />
            <criterion test_ref="test_deny_groups_is_configured_usr_etc_ssh_sshdconfig" />
            <criterion test_ref="test_allow_user_is_configured_etc_ssh_sshdconfig_dir" />
            <criterion test_ref="test_allow_groups_is_configured_etc_ssh_sshdconfig_dir" />
            <criterion test_ref="test_deny_users_is_configured_etc_ssh_sshdconfig_dir" />
            <criterion test_ref="test_deny_groups_is_configured_etc_ssh_sshdconfig_dir" />
            <criterion test_ref="test_allow_user_is_configured_usr_etc_ssh_sshdconfig_dir" />
            <criterion test_ref="test_allow_groups_is_configured_usr_etc_ssh_sshdconfig_dir" />
            <criterion test_ref="test_deny_users_is_configured_usr_etc_ssh_sshdconfig_dir" />
            <criterion test_ref="test_deny_groups_is_configured_usr_etc_ssh_sshdconfig_dir" />
        </criteria>
      </criteria>
    </criteria>
  </definition>

  <unix:file_test check="all" check_existence="all_exist"
      comment="SSH configuration /etc/ssh/sshd_config exists"
      id="test_etc_ssh_sshd_config_exist"
      state_operator="AND" version="1">
    <unix:object object_ref="obj_etc_ssh_sshd_config_exist"/>
  </unix:file_test>
  <unix:file_object
      comment="SSH configuration /etc/ssh/sshd_config exists"
      id="obj_etc_ssh_sshd_config_exist" version="1">
    <unix:filepath operation="pattern match">^/etc/ssh/sshd_config</unix:filepath>
  </unix:file_object>

  {{{ test_sshd_lineinfile("/etc/ssh/sshd_config", "AllowUsers", "test_allow_user_is_configured_etc_ssh_sshdconfig") }}}
  {{{ test_sshd_lineinfile("/etc/ssh/sshd_config", "AllowGroups", "test_allow_groups_is_configured_etc_ssh_sshdconfig") }}}
  {{{ test_sshd_lineinfile("/etc/ssh/sshd_config", "DenyUsers", "test_deny_users_is_configured_etc_ssh_sshdconfig") }}}
  {{{ test_sshd_lineinfile("/etc/ssh/sshd_config", "DenyGroups", "test_deny_groups_is_configured_etc_ssh_sshdconfig") }}}

  {{{ test_sshd_lineinfile("/usr/etc/ssh/sshd_config", "AllowUsers", "test_allow_user_is_configured_usr_etc_ssh_sshdconfig") }}}
  {{{ test_sshd_lineinfile("/usr/etc/ssh/sshd_config", "AllowGroups", "test_allow_groups_is_configured_usr_etc_ssh_sshdconfig") }}}
  {{{ test_sshd_lineinfile("/usr/etc/ssh/sshd_config", "DenyUsers", "test_deny_users_is_configured_usr_etc_ssh_sshdconfig") }}}
  {{{ test_sshd_lineinfile("/usr/etc/ssh/sshd_config", "DenyGroups", "test_deny_groups_is_configured_usr_etc_ssh_sshdconfig") }}}

  {{{ test_sshd_lineindir("/etc/ssh/sshd_config.d", "AllowUsers", "test_allow_user_is_configured_etc_ssh_sshdconfig_dir") }}}
  {{{ test_sshd_lineindir("/etc/ssh/sshd_config.d", "AllowGroups", "test_allow_groups_is_configured_etc_ssh_sshdconfig_dir") }}}
  {{{ test_sshd_lineindir("/etc/ssh/sshd_config.d", "DenyUsers", "test_deny_users_is_configured_etc_ssh_sshdconfig_dir") }}}
  {{{ test_sshd_lineindir("/etc/ssh/sshd_config.d", "DenyGroups", "test_deny_groups_is_configured_etc_ssh_sshdconfig_dir") }}}

  {{{ test_sshd_lineindir("/usr/etc/ssh/sshd_config.d", "AllowUsers", "test_allow_user_is_configured_usr_etc_ssh_sshdconfig_dir") }}}
  {{{ test_sshd_lineindir("/usr/etc/ssh/sshd_config.d", "AllowGroups", "test_allow_groups_is_configured_usr_etc_ssh_sshdconfig_dir") }}}
  {{{ test_sshd_lineindir("/usr/etc/ssh/sshd_config.d", "DenyUsers", "test_deny_users_is_configured_usr_etc_ssh_sshdconfig_dir") }}}
  {{{ test_sshd_lineindir("/usr/etc/ssh/sshd_config.d", "DenyGroups", "test_deny_groups_is_configured_usr_etc_ssh_sshdconfig_dir") }}}
</def-group>
