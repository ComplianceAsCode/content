# platform = multi_platform_ubuntu
# reboot = false
# strategy = restrict
# complexity = low
# disruption = low

- name: "{{{ rule_title }}} - Gather Package Facts"
  ansible.builtin.package_facts:

- name: "{{{ rule_title }}} - Check if cert_policy in /etc/pam_pkcs11/pam_pkcs11.conf Is Already Set"
  ansible.builtin.lineinfile:
      path: /etc/pam_pkcs11/pam_pkcs11.conf
      regexp: ^(\s*)cert_policy\s+.*
      state: absent
  check_mode: true
  changed_when: false
  register: cert_policy_replace
  when: '"{{{ pam_package }}}" in ansible_facts.packages'

- name: "{{{ rule_title }}} - Ensure 'none' Parameter for cert_policy in /etc/pam_pkcs11/pam_pkcs11.conf Is Removed"
  ansible.builtin.replace:
      path: /etc/pam_pkcs11/pam_pkcs11.conf
      regexp: (^\s*cert_policy\s*=\s*)none\s*;(\s*$)
      replace: \g<1>ca,signature,ocsp_on,crl_auto;\g<2>
  when:
  - cert_policy_replace.found > 0 
  - '"{{{ pam_package }}}" in ansible_facts.packages'

- name: "{{{ rule_title }}} - Add 'crl_auto' Parameter for cert_policy in /etc/pam_pkcs11/pam_pkcs11.conf"
  ansible.builtin.replace:
      path: /etc/pam_pkcs11/pam_pkcs11.conf
      regexp: (^\s*cert_policy\s*=\s*)(?!.*crl_auto)(.*)
      replace: \g<1>crl_auto,\g<2>
  when:
  - cert_policy_replace.found > 0 
  - '"{{{ pam_package }}}" in ansible_facts.packages'

- name: "{{{ rule_title }}} - Add cert_policy if It Does Not Exist"
  ansible.builtin.lineinfile:
      path: /etc/pam_pkcs11/pam_pkcs11.conf
      line: cert_policy = ca,signature,ocsp_on,crl_auto;
      state: present
      create: true
  when: 
  - cert_policy_replace.found == 0
  - '"{{{ pam_package }}}" in ansible_facts.packages'
