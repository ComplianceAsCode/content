# platform = multi_platform_rhel,multi_platform_fedora,multi_platform_ol,multi_platform_rhv
# reboot = false
# strategy = configure
# complexity = low
# disruption = medium
- name: Check if system relies on authselect
  ansible.builtin.stat:
    path: /usr/bin/authselect
  register: result_authselect_present

- name: Check integrity of authselect current profile
  ansible.builtin.command:
    cmd: authselect check
  register: result_authselect_check_cmd
  changed_when: false
  ignore_errors: yes
  when:
    - result_authselect_present.stat.exists

- name: Get authselect current profile
  ansible.builtin.shell:
    cmd: authselect current -r | awk '{ print $1 }'
  register: result_authselect_profile
  changed_when: false
  when:
    - result_authselect_check_cmd is failed

- name: Get authselect current features
  ansible.builtin.shell:
    cmd: authselect current | tail -n+3 | awk '{ print $2 }'
  register: result_authselect_features
  changed_when: false
  when:
    - result_authselect_present.stat.exists

- name: Define the current authselect profile as a local fact
  ansible.builtin.set_fact:
    authselect_profile: "{{ result_authselect_profile.stdout }}"
  when:
    - result_authselect_check_cmd is failed
    - result_authselect_profile is not skipped

- name: Restore the authselect profile if manually modified
  ansible.builtin.command:
    cmd: authselect select {{ authselect_profile }} --force
  register: result_pam_authselect_restore_profile
  when:
    - result_authselect_check_cmd is failed
    - result_authselect_profile is not skipped

- name: Restore the authselect features if manually modified
  ansible.builtin.command:
    cmd: authselect enable-feature {{ item }}
  register: result_pam_authselect_restore_features
  loop: "{{ result_authselect_features.stdout_lines }}"
  when:
    - result_authselect_check_cmd is failed
    - result_authselect_features is not skipped

- name: "Ensure nullok property is absent via authselect tool"
  ansible.builtin.command:
    cmd: authselect enable-feature without-nullok
  register: result_authselect_cmd
  when:
    - result_authselect_present.stat.exists
    - result_authselect_features.stdout is not search("without-nullok")

- name: "Ensure nullok property is absent by directly editing pam files"
  replace:
    dest: "{{ item }}"
    regexp: 'nullok'
  loop:
    - /etc/pam.d/system-auth
    - /etc/pam.d/password-auth
  when:
    - not result_authselect_present.stat.exists
