{{%- set basedir="/var/tmp" -%}}
{{%- set basename=basedir.lstrip('/').replace('/', '_') -%}}
<def-group>
  <definition class="compliance" id="accounts_polyinstantiated_{{{ basename }}}" version="1">
    {{{ oval_metadata("") }}}
    <criteria operator="AND" comment="Check Polyinstantiation of {{{ basedir }}} Directories">
      <criterion comment="Check that {{{ basedir }}}/tmp-inst exists and has mode 000" test_ref="test_{{{ basename }}}_tmp_inst" />
      <criterion comment="Check configuration of {{{ basedir }}} in /etc/security/namespace.conf file" test_ref="test_{{{ basename }}}_in_namespace_conf" />
    </criteria>
  </definition>

  <unix:file_test comment="Check that {{{ basedir }}}/tmp-inst exists and has mode 000" check="all" check_existence="only_one_exists" id="test_{{{ basename }}}_tmp_inst" version="1">
    <unix:object object_ref="obj_{{{ basename }}}_tmp_inst" />
    <unix:state state_ref="state_{{{ basename }}}_tmp_inst" />
  </unix:file_test>

  <unix:file_object id="obj_{{{ basename }}}_tmp_inst" version="1">
    <unix:path>{{{ basedir }}}/tmp-inst</unix:path>
    <unix:filename xsi:nil="true" />
  </unix:file_object>

  <unix:file_state id="state_{{{ basename }}}_tmp_inst" version="1">
    <unix:type>directory</unix:type>
    <unix:uread datatype="boolean">false</unix:uread>
    <unix:uwrite datatype="boolean">false</unix:uwrite>
    <unix:uexec datatype="boolean">false</unix:uexec>
    <unix:gread datatype="boolean">false</unix:gread>
    <unix:gwrite datatype="boolean">false</unix:gwrite>
    <unix:gexec datatype="boolean">false</unix:gexec>
    <unix:oread datatype="boolean">false</unix:oread>
    <unix:owrite datatype="boolean">false</unix:owrite>
    <unix:oexec datatype="boolean">false</unix:oexec>
  </unix:file_state>

  <ind:textfilecontent54_test check="all"
    comment="Check configuration of {{{ basedir }}} in /etc/security/namespace.conf file"
    id="test_{{{ basename }}}_in_namespace_conf" version="1">
  <ind:object object_ref="obj_{{{ basename }}}_in_namespace_conf" />
  </ind:textfilecontent54_test>

{{#-
   man adduser(8)

   Usernames may contain only lower and upper case letters, digits,
   underscores, or dashes. They can end with a dollar sign. Dashes are
   not allowed at the beginning of the username. Fully numeric usernames
   and usernames . or .. are also disallowed. It is not recommended to
   use usernames beginning with . character as their home directories
   will be hidden in the ls output.

   Usernames may only be up to 32 characters long.
-#}}
{{%- set rx_username="(?:[[:alpha:]_][\w-]{0,30}[\w$-]?)" -%}}
{{#-
   man namespace.conf(5)
   ...
   The fields are separated by spaces but can be quoted by " characters
   also escape sequences \b, \n, and \t are recognized. The fields are
   as follows:

   polydir instance_prefix method list_of_uids
   ...

   Some situations not supported here:
   -  quotation
   -  escapes
   - `mntopts` with `context` directive

   This regexp implementation only somewhat resembles what parser accepts.

   Deny `shared` method.
-#}}
{{%- set rx_sep="\s+" -%}}
{{%- set rx_flag_create="(?:create(=\d*(?:,\d*(?:,\d+)?)?)?)" -%}}
{{%- set rx_flag_iscript="(?:iscript=[^\s:]+)" -%}}
{{%- set rx_flag_noinit="(?:noinit)" -%}}
{{%- set rx_flag_mntopts="(?:mntopts=[^\s:]+)" -%}}
{{%- set rx_methods_rest="(?:user|level|context|tmpdir)(?::(?:" ~ rx_flag_create ~ "|" ~ rx_flag_iscript ~ "|" ~ rx_flag_noinit ~ "))*" -%}}
{{%- set rx_method_tmpfs="tmpfs(?::(?:" ~ rx_flag_create ~ "|" ~ rx_flag_iscript ~ "|" ~ rx_flag_noinit~ "|" ~ rx_flag_mntopts ~ "))*" -%}}
{{%- set rx_method="(?:" ~ rx_methods_rest ~ "|" ~ rx_method_tmpfs ~ ")" -%}}
{{%- set rx_list_of_uids="(?:[~]?" ~ rx_username ~ "(?:," ~ rx_username ~ ")*)?" -%}}
  <ind:textfilecontent54_object id="obj_{{{ basename }}}_in_namespace_conf" version="1">
    <ind:filepath operation="pattern match">^/etc/security/namespace(?:|\.d/[^/]*)\.conf$</ind:filepath>
    <ind:pattern operation="pattern match">^\s*{{{ basedir }}}{{{ rx_sep }}}{{{ basedir }}}/tmp-inst/{{{ rx_sep }}}{{{ rx_method }}}{{{ rx_sep }}}{{{ rx_list_of_uids }}}\s*$</ind:pattern>
    <ind:instance operation="greater than or equal" datatype="int">1</ind:instance>
  </ind:textfilecontent54_object>
</def-group>
