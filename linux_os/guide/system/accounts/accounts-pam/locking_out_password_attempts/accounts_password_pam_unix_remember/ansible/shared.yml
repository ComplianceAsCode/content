# platform = multi_platform_rhel,multi_platform_fedora,multi_platform_ol,multi_platform_rhv,multi_platform_sle,multi_platform_ubuntu
# reboot = false
# strategy = configure
# complexity = low
# disruption = medium

{{% if product in [ "sle12", "sle15" ] or product in [ "ubuntu1804", "ubuntu2004" ] %}}
{{%- set accounts_password_pam_unix_remember_file = '/etc/pam.d/common-password' -%}}
{{% else %}}
{{%- set accounts_password_pam_unix_remember_file = '/etc/pam.d/system-auth' -%}}
{{% endif %}}

{{{ ansible_instantiate_variables("var_password_pam_unix_remember") }}}

{{% if product not in ['ubuntu2004'] %}}

{{{ ansible_pam_pwhistory_enable(accounts_password_pam_unix_remember_file,
                                 'requisite',
                                 '^password.*requisite.*pam_pwquality\.so') }}}

{{{ ansible_pam_pwhistory_parameter_value(accounts_password_pam_unix_remember_file,
                                          'remember',
                                          '{{ var_password_pam_unix_remember }}') }}}

{{% else %}}
{{{ ansible_ensure_pam_module_line(accounts_password_pam_unix_remember_file,
                                          "password",
                                          "[success=1 default=ignore]",
                                          "pam_unix.so obscure sha512 shadow remember=5 rounds=5000")}}}

{{% endif %}}
