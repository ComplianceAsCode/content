# platform = multi_platform_rhel,multi_platform_fedora,multi_platform_ol,multi_platform_rhv,multi_platform_sle
# reboot = false
# strategy = configure
# complexity = low
# disruption = medium
{{{ ansible_instantiate_variables("var_password_pam_unix_remember") }}}

{{% macro ansible_pam_remember(path, module, control) %}}
- name: "Do not allow users to reuse recent passwords ({{{ module }}}) - {{{ path }}} (change)"
  replace:
    dest: {{{ path }}}
    regexp: '^(password\s+{{{ control }}}\s+{{{ module }}}\.so\s.*remember\s*=\s*)(\S+)(.*)$'
    replace: '\g<1>{{ var_password_pam_unix_remember }}\g<3>'

- name: "Do not allow users to reuse recent passwords ({{{ module }}}) - {{{ path }}} (add)"
  replace:
    dest: {{{ path }}}
    regexp: '^password\s+{{{ control }}}\s+{{{ module }}}\.so\s(?!.*remember\s*=\s*).*$'
    replace: '\g<0> remember={{ var_password_pam_unix_remember }}'
{{%- endmacro -%}}

{{{ ansible_pam_remember(path="/etc/pam.d/system-auth", module="pam_unix", control="sufficient") }}}
{{{ ansible_pam_remember(path="/etc/pam.d/password-auth", module="pam_unix", control="sufficient") }}}
