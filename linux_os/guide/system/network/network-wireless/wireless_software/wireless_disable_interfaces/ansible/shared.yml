# platform = multi_platform_all
# reboot = false
# strategy = unknown
# complexity = low
# disruption = medium

- name: "{{{ rule_title }}} - Service facts"
  ansible.builtin.service_facts:

{{% if product in ["sle12", "sle15", "slmicro5"] %}}

- name: "{{{ rule_title }}} - Wicked Deactivate Wireless Network Interfaces"
  ansible.builtin.command: wicked ifdown {{ item }}
  loop: '{{ ansible_facts.interfaces }}'
  when:
    - ansible_facts.services['wickedd.service'].state == 'running'
    - 'item.startswith("wl")'

- name: "{{{ rule_title }}} - Wicked Disable Wireless Network Interfaces"
  ansible.builtin.lineinfile:
    path: /etc/sysconfig/network/ifcfg-{{ item }}
    regexp: '^STARTMODE='
    line: STARTMODE=off
  loop: '{{ ansible_facts.interfaces }}'
  when:
    - ansible_facts.services['wickedd.service'].state == 'running'
    - 'item.startswith("wl")'
{{%- else %}}

- name: "{{{ rule_title }}} - Ensure NetworkManager is installed"
  ansible.builtin.package:
    name: "{{ item }}"
    state: present
  with_items:
    - NetworkManager

{{%- endif %}}

- name: "{{{ rule_title }}} - NetworkManager Deactivate Wireless Network Interfaces"
  ansible.builtin.command: nmcli radio wifi off
  when:
    - "'NetworkManager' in ansible_facts.packages"
    - ansible_facts.services['NetworkManager.service'].state == 'running'
