# platform = multi_platform_all
# reboot = true
# strategy = restrict
# complexity = low
# disruption = low
- name: "{{{ rule_title }}}: set_fact"
  set_fact:
    path: /etc/crypto-policies/back-ends/gnutls.config
    correct_value: '+VERS-ALL:-VERS-DTLS0.9:-VERS-SSL3.0:-VERS-TLS1.0:-VERS-TLS1.1:-VERS-DTLS1.0'
    lineinfile_reg: \+VERS-ALL:-VERS-DTLS0\.9:-VERS-SSL3\.0:-VERS-TLS1\.0:-VERS-TLS1\.1:-VERS-DTLS1\.0

- name: "{{{ rule_title }}}: stat"
  stat:
    path: "{{ path }}"
    follow: yes
  register: gnutls_file

- name: "{{{ rule_title }}}: Create file and add line"
  lineinfile:
    path: "{{ path }}"
    regexp: "{{ lineinfile_reg }}"
    line: "{{ correct_value }}"
    create: yes
  when: not gnutls_file.stat.exists

- name: "{{{ rule_title }}}"
  block:
    - name: "{{{ rule_title }}}: Update"
      replace:
        path: "{{ path }}"
        regexp: (\+VERS-ALL(?::-VERS-[A-Z]+\d\.\d)+)
        replace: "{{ correct_value }}"
      register: gnutls_crypto_replaced

    - name: "{{{ rule_title }}}: Existing value check"
      lineinfile:
        path: "{{ path }}"
        line: "{{ correct_value }}"
        create: false
        regexp: "{{ lineinfile_reg }}"
        state: present
      when: gnutls_crypto_replaced is not changed

  when: gnutls_file.stat.exists

