# platform = multi_platform_all
# reboot = false
# strategy = restrict
# complexity = low
# disruption = low
- name: "{{{ rule_title }}} - Ensure AIDE is installed"
  ansible.builtin.package:
    name: aide
    state: present

- name: "{{{ rule_title }}} - Install cron"
  ansible.builtin.package:
{{% if "ubuntu" in product or "debian" in product %}}
    name: cron
{{% else %}}
    name: cronie
{{% endif %}}
    state: present

- name: "{{{ rule_title }}} - Gather List of Installed Packages"
  ansible.builtin.package_facts:
    manager: auto

{{% if product != 'ubuntu2404' %}}
- name: "{{{ rule_title }}} - Setup Cron Tab"
  ansible.builtin.cron:
{{% if product in ["sle12", "sle15", "sle16"] %}}
    name: "{{{ rule_title }}}"
    cron_file: /etc/cron.d/dailyaidecheck
{{% else %}}
    name: "run AIDE check"
{{% endif %}}
    minute: 05
    hour: 04
    user: root
    job: "{{{ aide_bin_path }}} --check"
  register: crontab_check
{{% if "ubuntu" in product or "debian" in product %}}
  when: "'cron' in ansible_facts.packages"
{{% else %}}
  when: "'cronie' in ansible_facts.packages"
{{% endif %}}

{{% else %}}
- name: "{{{ rule_title }}} - Install AIDE Cron Job"
  ansible.builtin.lineinfile:
    path: /etc/cron.daily/dailyaidecheck
    line: 'SCRIPT="/usr/share/aide/bin/dailyaidecheck"'
  check_mode: yes
  register: line_check

- name: "{{{ rule_title }}} - Install AIDE cron script"
  ansible.builtin.copy:
    src: /usr/share/aide/config/cron.daily/dailyaidecheck
    dest: /etc/cron.daily/dailyaidecheck
  when: not line_check.found
{{% endif %}}
