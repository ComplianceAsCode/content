{{% set expected_symlinks_src_dir = "/etc/crypto-policies/back-ends/" %}}
{{% set expected_symlinks_dest_dir = "/usr/share/crypto-policies/FIPS/" %}}
{{% set openssh_client_policy_file = openssh_client_crypto_policy_config_file %}}
{{% set openssh_server_policy_file = openssh_server_crypto_policy_config_file %}}
{{% set openssh_client_policy_target = expected_symlinks_dest_dir ~ "openssh.txt" %}}
{{% set openssh_server_policy_target = expected_symlinks_dest_dir ~ "opensshserver.txt" %}}
{{% set expected_symlinks_src_files = [ "bind",
                                        "gnutls",
                                        "java",
                                        "javasystem",
                                        "krb5",
                                        "libreswan",
                                        "libssh",
                                        "opensslcnf",
                                        "openssl",
                                        "openssl_fips"
                                        ] %}}

{{% set symlinks_src_ext = ".config" %}}
{{% set symlinks_dest_ext = ".txt" %}}

<def-group>
    <definition class="compliance" id="{{{ rule_id }}}" version="1">
        {{{ oval_metadata("All system wide cryptopolicy symblinks should point to FIPS policy", rule_title=rule_title) }}}
        <criteria operator="AND" comment="All crypto-policies symlinks should point to FIPS">
            {{% for symlink in expected_symlinks_src_files %}}
            <criterion comment="Symlink from {{{ expected_symlinks_src_dir ~ symlink }}}"
                test_ref="test_symlink_from_{{{ symlink | escape_id }}}" />
            {{% endfor %}}
            <criterion comment="Symlink from {{{ openssh_client_policy_file }}}"
                test_ref="test_symlink_from_openssh_client_policy" />
            <criterion comment="Symlink from {{{ openssh_server_policy_file }}}"
                test_ref="test_symlink_from_openssh_server_policy" />
        </criteria>
    </definition>

    {{% for symlink in expected_symlinks_src_files %}}
    <unix:symlink_test check="all" check_existence="all_exist"
            comment="{{{ expected_symlinks_src_dir ~ symlink }}} points to fips" version="1"
            id="test_symlink_from_{{{ symlink | escape_id }}}">
        <unix:object object_ref="object_symlink_from_{{{ symlink | escape_id }}}" />
        <unix:state state_ref="state_symlink_from_{{{ symlink | escape_id }}}" />
    </unix:symlink_test>
    <unix:symlink_object comment="{{{ expected_symlinks_src_dir ~ symlink }}}" version="1"
            id="object_symlink_from_{{{ symlink | escape_id }}}">
        <unix:filepath>{{{ expected_symlinks_src_dir ~ symlink ~ symlinks_src_ext}}}</unix:filepath>
    </unix:symlink_object>
    <unix:symlink_state comment="{{{ expected_symlinks_src_dir ~ symlink }}} points to fips" version="1"
            id="state_symlink_from_{{{ symlink | escape_id }}}">
        <unix:canonical_path operation="equals">{{{ expected_symlinks_dest_dir
            ~ symlink ~ symlinks_dest_ext }}}</unix:canonical_path>
    </unix:symlink_state>
    {{% endfor %}}

    <unix:symlink_test check="all" check_existence="all_exist"
            comment="{{{ openssh_client_policy_file }}} points to fips" version="1"
            id="test_symlink_from_openssh_client_policy">
        <unix:object object_ref="object_symlink_from_openssh_client_policy" />
        <unix:state state_ref="state_symlink_from_openssh_client_policy" />
    </unix:symlink_test>
    <unix:symlink_object comment="{{{ openssh_client_policy_file }}}" version="1"
            id="object_symlink_from_openssh_client_policy">
        <unix:filepath>{{{ openssh_client_policy_file }}}</unix:filepath>
    </unix:symlink_object>
    <unix:symlink_state comment="{{{ openssh_client_policy_file }}} points to fips" version="1"
            id="state_symlink_from_openssh_client_policy">
        <unix:canonical_path operation="equals">{{{ openssh_client_policy_target }}}</unix:canonical_path>
    </unix:symlink_state>

    <unix:symlink_test check="all" check_existence="all_exist"
            comment="{{{ openssh_server_policy_file }}} points to fips" version="1"
            id="test_symlink_from_openssh_server_policy">
        <unix:object object_ref="object_symlink_from_openssh_server_policy" />
        <unix:state state_ref="state_symlink_from_openssh_server_policy" />
    </unix:symlink_test>
    <unix:symlink_object comment="{{{ openssh_server_policy_file }}}" version="1"
            id="object_symlink_from_openssh_server_policy">
        <unix:filepath>{{{ openssh_server_policy_file }}}</unix:filepath>
    </unix:symlink_object>
    <unix:symlink_state comment="{{{ openssh_server_policy_file }}} points to fips" version="1"
            id="state_symlink_from_openssh_server_policy">
        <unix:canonical_path operation="equals">{{{ openssh_server_policy_target }}}</unix:canonical_path>
    </unix:symlink_state>
</def-group>
