# platform = multi_platform_fedora,multi_platform_ol,multi_platform_rhel,multi_platform_sle,multi_platform_slmicro,multi_platform_almalinux
# reboot = false
# strategy = restrict
# complexity = medium
# disruption = medium

- name: "{{{ rule_title }}} - Find system command files with incorrect group ownership"
  ansible.builtin.find:
    paths: "{{ item }}"
    file_type: file
    follow: no
    recurse: no
  register: system_command_files_found
  {{% if 'ol9' in product %}}
  with_items: ['/bin', '/sbin', '/usr/bin', '/usr/sbin', '/usr/libexec','/usr/local/bin', '/usr/local/sbin']
  {{% else %}}
  with_items: ['/bin', '/sbin', '/usr/bin', '/usr/sbin', '/usr/local/bin', '/usr/local/sbin']
  {{% endif %}}
  changed_when: false

- name: "{{{ rule_title }}} - Set group ownership to root for system command files"
  ansible.builtin.file:
    path: "{{ item.path }}"
    group: root
{{% if 'ubuntu' in product %}}
  with_items: '{{ system_command_files_found.results | map(attribute=''files'')
      | flatten | rejectattr(''gid'', ''lesserthan'', {{{ gid_min }}}) | list }}'
{{% else %}}
  with_items: '{{ system_command_files_found.results | map(attribute=''files'')
      | flatten | rejectattr(''gr_name'', ''equalto'', ''root'') | list }}'
{{% endif %}}
