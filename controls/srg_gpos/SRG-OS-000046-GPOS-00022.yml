controls:
    -   id: SRG-OS-000046-GPOS-00022
        levels:
            - medium
        title: {{{ full_name }}} must alert the ISSO and SA (at a minimum) in the event
            of an audit processing failure.
        rules:
            - postfix_client_configure_mail_alias
            - postfix_client_configure_mail_alias_postmaster
            - var_postfix_root_mail_alias=mil_sysadmin
            - audit_rules_system_shutdown
            - var_audit_failure_mode=panic
            - auditd_data_retention_action_mail_acct
            - var_auditd_action_mail_acct=root
        status: automated
        # This control is solved by an OCP-4 rule which needs to be explicitly
        # added to the ocp4-stig profile
        rules@rhcos4:
            - audit_error_alert_exists
        checktext@rhcos4: |-
            Verify that there is a prometheus rule to watch for audit events

            > oc get prometheusrule -o yaml --all-namespaces | grep apiserver_audit

                    sum by (apiserver,instance)(rate(apiserver_audit_error_total{apiserver=~".+-apiserver"}[5m])) / sum by (apiserver,instance) (rate(apiserver_audit_event_total{apiserver=~".+-apiserver"}[5m])) > 0

            If the output above is not displayed, this is a finding

        fixtext@rhcos4: |-
            Apply the following prometheus rule

            > oc apply -f - << 'EOF'
            ---
            apiVersion: monitoring.coreos.com/v1
            kind: PrometheusRule
            metadata:
              name: audit-errors
              namespace: openshift-kube-apiserver
            spec:
              groups:
              - name: apiserver-audit
                rules:
                - alert: AuditLogError
                  annotations:
                    summary: |-
                      An API Server instance was unable to write audit logs. This could be
                      triggered by the node running out of space, or a malicious actor
                      tampering with the audit logs.
                    description: An API Server had an error writing to an audit log.
                  expr: |
                    sum by (apiserver,instance)(rate(apiserver_audit_error_total{apiserver=~".+-apiserver"}[5m])) / sum by (apiserver,instance) (rate(apiserver_audit_event_total{apiserver=~".+-apiserver"}[5m])) > 0
                  for: 1m
                  labels:
                    severity: warning
            EOF