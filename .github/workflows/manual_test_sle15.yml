# This is a basic workflow that is manually triggered

name: Manual workflow

# Controls when the action will run. Workflow runs when manually triggered using the UI
# or API.
on:
  workflow_dispatch:
    branches: [ master, 'stabilization*' ]

env: 
  DATASTREAM: ssg-sle15-ds.xml
jobs:
  # This workflow contains a single job called "greet"
  build-content:
    name: Build Content
    runs-on: ubuntu-latest
    container: 
      image: registry.suse.com/suse/sle15:15.4
    steps:
      - name: Update CA certificates
        run: update-ca-certificates
      - name: Zypper refs  
        run: zypper refs
      - name: Zypper refresh  
        run: zypper refresh 
      - name: Install deps
        run: zypper --non-interactive in cmake ninja expat openssh-clients openssh-server openscap-utils tar gzip git python3 python3-rpm python3-pip python3-devel libxml2-tools libxslt-tools python3-PyYAML
      - name: Upgrade pip python
        run: pip install pip --upgrade
      - name: Install deps python
        run: pip install json2html sphinxcontrib.jinjadomain GitPython
      - name: Checkout
        uses: actions/checkout@v3
        with: 
          fetch-depth: 0
      - name: Checkout (CTF)
        uses: actions/checkout@v3
        with: 
          repository: ComplianceAsCode/content-test-filtering
          path: ctf
      - name: Set git safe directory
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"
      - name: Find forking point
        env: 
          BASE_BRANCH: ${{ github.base_ref }}
        run: echo "FORK_POINT=$(git merge-base origin/$BASE_BRANCH ${{ github.event.pull_request.head.sha }})" >> $GITHUB_OUTPUT
        id: fork point
          
